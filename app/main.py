# app/main.py
from __future__ import annotations

import builtins
import traceback
from contextlib import asynccontextmanager
from importlib import import_module

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from starlette.exceptions import HTTPException as StarletteHTTPException

# ?ъ씠???댄럺???좎?(DB/紐⑤뜽 珥덇린??
from . import models, database  # noqa: F401
from app.config import project_rules as R
from app.routers import admin_deposit

# ????????????????????????????????????????????????
# 0) ORMModel ?꾩뿭 ??shim) ???쇰? ?쇱슦?곌? 吏곸젒 ?곸냽?섎ŉ import瑜????섎뒗 寃쎌슦 諛⑹?
# ????????????????????????????????????????????????
try:
    from app.schemas import ORMModel as _ORMModel  # type: ignore
except Exception:
    try:
        from pydantic import BaseModel as _ORMModel  # type: ignore
    except Exception:
        _ORMModel = object
builtins.ORMModel = _ORMModel  # ?쇱슦??紐⑤뱢 ?꾩뿭?먯꽌 李몄“ 媛??

# ????????????????????????????????????????????????
# Lifespan (on_event deprecation ?뚰뵾)
# ????????????????????????????????????????????????
@asynccontextmanager
async def lifespan(app: FastAPI):
    try:
        R.set_test_now_utc(None)
    except Exception:
        pass
    yield
    try:
        R.set_test_now_utc(None)
    except Exception:
        pass

app = FastAPI(title="Yeokping Ver2 API, version=3.5", lifespan=lifespan)

DEV_DEBUG_ERRORS = False

# ????????????????????????????????????????????????
# ?꾩뿭 ?덉쇅 ?몃뱾??
# ????????????????????????????????????????????????
@app.exception_handler(StarletteHTTPException)
async def http_exc_handler(request, exc: StarletteHTTPException):
    return JSONResponse(status_code=exc.status_code, content={"detail": exc.detail})

@app.exception_handler(Exception)
async def unhandled_exc_handler(request, exc: Exception):
    if DEV_DEBUG_ERRORS:
        tb_tail = traceback.format_exc().splitlines()[-1]
        return JSONResponse(
            status_code=500,
            content={"detail": {
                "error": exc.__class__.__name__,
                "msg": str(exc),
                "where": f"{request.method} {request.url.path}",
                "trace_tail": tb_tail,
            }},
        )
    return JSONResponse(status_code=500, content={"detail": "Internal error"})

# ????????????????????????????????????????????????
# CORS
# ????????????????????????????????????????????????
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ????????????????????????????????????????????????
# Router ?덉쟾 ?ы븿 ?좏떥
# ????????????????????????????????????????????????
def _include_router_safe(module_name: str, attrs: tuple[str, ...] = ("router",), label: str | None = None):
    """
    app.routers.<module_name> (???ы븿 ?덉슜)瑜?import????attrs ?꾨낫?먯꽌 router瑜?李얠븘 include.
    ?ㅽ뙣?대룄 ?깆? 怨꾩냽 ?④퀬 寃쎄퀬留?異쒕젰.
    """
    try:
        mod = import_module(f"app.routers.{module_name}")
        for attr in attrs:
            r = getattr(mod, attr, None)
            if r is not None:
                app.include_router(r)
                return
        raise AttributeError(f"no attr in {attrs}")
    except Exception as e:
        print(f"?좑툘  Skip router [{label or module_name}]: {e}")

# ????????????????????????????????????????????????
# 媛쒕퀎/蹂댁“ ?쇱슦?????ы븿
# ????????????????????????????????????????????????
_include_router_safe("auth", ("router",), label="auth")
_include_router_safe("buyers", ("router",), label="buyers")
_include_router_safe("sellers", ("router",), label="sellers")
_include_router_safe("deals", ("router",), label="deals")
_include_router_safe("points", ("router",), label="points")
_include_router_safe("payments", ("router",), label="payments")

# ??routes_extended??"?⑦궎吏" 援ъ“瑜?吏?? ?쒕툕紐⑤뱢??吏곸젒 濡쒕뱶
_include_router_safe("routes_extended.buyers_extended", ("router",), label="routes_extended.buyers")
_include_router_safe("routes_extended.sellers_extended", ("router",), label="routes_extended.sellers")

# Admin/?쒕?/?듦퀎
_include_router_safe("admin_policy", ("router",), label="admin_policy")
_include_router_safe("deposits", ("router",), label="deposits")
_include_router_safe("admin_simulate", ("router",), label="admin_simulate")
_include_router_safe("admin_dashboard", ("router",), label="admin_dashboard")
_include_router_safe("admin_simulate_status", ("router",), label="admin_simulate_status")
_include_router_safe("simulate_v3_6", ("router",), label="simulate_v3_6")
_include_router_safe("simulate_v3_6_run", ("router",), label="simulate_v3_6_run")
_include_router_safe("offers_extras", ("router", "api"), label="offers_extras")
_include_router_safe("admin_deposit", ("api","router"), label="admin_deposit")

# ????????????????????????????????????????????????
# v3.5 ?꾩슜 ?쇱슦????留덉?留??곗꽑沅?蹂댁옣)
# ????????????????????????????????????????????????
_include_router_safe("offers", ("router_reservations_v35", "router", "api"), label="offers.reservations_v35")
_include_router_safe("offers", ("router_offers_v35", "router_offers", "api"), label="offers.offers_v35")

# ????????????????????????????????????????????????
# Health/Version
# ????????????????????????????????????????????????
@app.get("/")
def root():
    return {"message": "Yeokping Ver2 API(NO-AUTH) is running ??"}

@app.get("/health")
def health():
    return {"ok": True}

@app.get("/version")
def version():
    return {"app": "Yeokping Ver2 API", "version": "3.5-A-route R1"} # reload-ping
 # reload-ping 2025-11-20T15:12:53.3453425+09:00
 # reload-ping 2025-11-20T15:12:58.1551323+09:00

