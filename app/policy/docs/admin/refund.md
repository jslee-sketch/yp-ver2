 ADMIN ONLY: BUYER/SELLER 응답 근거로 사용 금지

# ?섎텋/遺꾩웳 ?뺤콉 (Refund & Dispute) ??SSOT v3.6

?섎텋? ?쒓컧?뺚앹씠 ?꾨땲???쒖쬆嫄??뺤콉/?쒓컙?앹쑝濡?泥섎━?댁빞 CS 鍮꾩슜??以꾧퀬,
?묓릟?대룄 媛숈? 寃곕줎???????덈떎.

??臾몄꽌??**?섎텋/遺꾩웳??SSOT(寃곗젙 吏??** 怨?**Evidence(?ㅻ깄??濡쒓렇)** 瑜?遺꾨━??
?댁쁺/?붾쾭源?CS ?ㅻ챸???붾뱾由ъ? ?딅룄濡?怨좎젙?쒕떎.

---

## 0) ??以??붿빟

- **SSOT(寃곗젙)**: ?섎텋 怨꾩궛/?덉슜/諛곗넚鍮??ы븿 ?щ???`refund_policy + crud preview/refund 濡쒖쭅`??寃곗젙?쒕떎.
- **Evidence(利앸튃)**: `Reservation.policy_snapshot_json.refund_snapshot`? ?쒓렇 ?쒖젏 ?뺤콉 ?뚮씪誘명꽣?앸? 諛뺤젣?쒕떎.
- **異붿쟻(濡쒓렇)**: ActivityLog???쒕Т???쇱씠 ?쇱뼱?щ뒗吏?앸? ?④릿??由ы뵆?덉씠/?듦퀎/?뺤콉 ?쒕떇).

---

## 1) 肄붾뱶 SSOT ?ъ씤???꾩옱 ?몃━)

### 1-1) ?섎텋 ?뺤콉 ?붿쭊/洹쒖튃(SSOT)
- `app/core/refund_policy.py`
  - `compute_cooling_state(...)`
  - `is_shipping_refundable_by_policy(...)` (諛곗넚鍮??섎텋 gate / ?듭뀡B)
  - `RefundPolicyEngine` (洹梨??뺤궛 ?곹깭???곕Ⅸ 寃곗젙)

### 1-2) ?섎텋 Preview / 怨꾩궛(SSOT)
- `app/crud.py`
  - `preview_refund_for_paid_reservation(...)`
    - 遺遺꾪솚遺??섎웾(qty) 泥섎━
    - 諛곗넚鍮??먮룞諛곗젙(Reservation.amount_shipping SSOT)
    - override + cap
    - shipping gate ?곸슜
    - preview 濡쒓렇(Event/Evidence Pack)
    - refund_snapshot 諛뺤젣(best-effort, 硫깅벑)
  - `preview_refund_for_reservation(...)` (admin ?쇱슦???명솚 ?섑띁)

### 1-3) 愿由ъ옄 ?꾨━酉?API
- `app/routers/admin_refund_preview.py`
  - `GET /admin/refund/preview?reservation_id=...&fault_party=...&trigger=...`

### 1-4) ?ㅼ젣 ?섎텋/痍⑥냼(吏묓뻾 SSOT)
- (議댁옱 湲곗?)
  - `/reservations/force_refund` (?댁쁺 媛뺤젣)
  - `refund_paid_reservation(...)` ???ㅼ젣 ???곹깭 蹂寃?CRUD

---

## 2) 遺꾩웳(Dispute) ?쇱슦??議댁옱 ?뺤씤)

- `/v3_6/{reservation_id}/dispute/open`
- `/v3_6/{reservation_id}/dispute/close`

遺꾩웳???대━硫?
- settlement/commission HOLD 媛??
- shipping/arrival_confirm ?꾩씠??蹂대쪟 媛??Freeze)

> ?쒕텇?곣앹? 洹梨낆씠 ?뺤젙?섏? ?딆? ?곹깭(DISPUTE)濡?痍④툒?????덉쑝硫?
> ?섎텋? DISPUTE_RESOLVE 媛숈? ?몃━嫄곗뿉???뺤젙 泥섎━?섎뒗 寃껋씠 ?덉쟾?섎떎.

---

## 3) Freeze(蹂대쪟) ?먯튃

- 遺꾩웳/李⑥?諛??섏떖 嫄곕옒???쒖옄???뺤젙/?뺤궛?앹쓣 硫덉텣??
- HOLD ?곹깭???쒓컙??吏?섎㈃ ?먮룞 ?댁젣?섎뒗 寃껋씠 ?꾨땲??
  1) 利앸튃 ?뺣낫
  2) 愿由ъ옄 ?먮떒
  3) ?뺤콉 湲곗? 異⑹”
  ??3媛吏濡??댁젣?쒕떎.

---

## 4) Cooling(荑⑤쭅) ?곹깭 SSOT

荑⑤쭅 ?곹깭??`compute_cooling_state(...)` 寃곌낵瑜?SSOT濡??쒕떎.

- BEFORE_SHIPPING: 寃곗젣???섏뿀吏留?諛쒖넚 ??
- SHIPPED_NOT_DELIVERED: 諛쒖넚? ?덉?留??꾩갑/援щℓ???뺤씤 ??
- WITHIN_COOLING: ?꾩갑(?먮뒗 ?섎졊?뺤젙) ??荑⑤쭅 湲곌컙 ?대궡
- AFTER_COOLING: ?꾩갑(?먮뒗 ?섎졊?뺤젙) ??荑⑤쭅 湲곌컙 寃쎄낵
- UNKNOWN: ?먮떒 遺덇?

### 4-1) 荑⑤쭅 湲곗???
- ?먯튃: `arrival_confirmed_at` 湲곗?
- fallback: `delivered_at` (arrival_confirmed_at???놁쓣 ??

### 4-2) cooling_days 寃곗젙 ?곗꽑?쒖쐞(SSOT)
1) `Reservation.policy_id` 濡??곌껐??`OfferPolicy.cancel_within_days`
2) `OfferPolicy.offer_id` 濡?議고쉶??`cancel_within_days`
3) `policy_api.cooling_days()`
4) `DEFAULT_COOLING_DAYS` ?덉쟾 fallback

(?뚯닔/怨쇰? 媛믪? 媛?쒕줈 蹂댁젙)

---

## 5) 諛곗넚鍮??섎텋 Gate(?듭뀡B) ??SSOT

諛곗넚鍮꾨? ?쒗솚遺덉뿉 ?ы븿?좎? ?щ??앸뒗 `is_shipping_refundable_by_policy(...)`瑜?SSOT濡??쒕떎.

**?듭뀡B 洹쒖튃(?붿빟)**

1) BEFORE_SHIPPING:
- 紐⑤뱺 trigger?????諛곗넚鍮??섎텋 ?덉슜

2) SHIPPED_NOT_DELIVERED / WITHIN_COOLING:
- BUYER_CANCEL留?遺덊뿀
- SELLER_CANCEL / SYSTEM_ERROR / ADMIN_FORCE / DISPUTE_RESOLVE ???덉슜

3) AFTER_COOLING:
- DISPUTE_RESOLVE留??덉슜
- 洹??몃뒗 遺덊뿀

4) UNKNOWN:
- 蹂댁닔?곸쑝濡?遺덊뿀

> 李멸퀬: ?쒗뿀???щ?(gate)?앹? ?쒓툑??怨꾩궛?앹? 遺꾨━?쒕떎.  
> 湲덉븸? preview?먯꽌 ?먮룞諛곗젙/override/cap濡?怨꾩궛?섎ŉ, gate媛 False硫?理쒖쥌 諛곗넚鍮??섎텋?≪? 0?대떎.

---

## 6) 遺遺꾪솚遺?Quantity) SSOT

- ?섎텋 ?섎웾? `Reservation.qty`, `Reservation.refunded_qty` 湲곕컲?쇰줈 ?곗젙?쒕떎.
- remaining = qty_total - already_refunded
- `quantity_refund` 誘몄엯????remaining ?꾩껜
- ?낅젰??remaining??珥덇낵?섎㈃ remaining?쇰줈 罹?

---

## 7) Refund Snapshot (Evidence) ???쒕컯?쒋??섎?

### 7-1) 諛뺤젣媛 ?섎??섎뒗 寃?
`Reservation.policy_snapshot_json.refund_snapshot`?
?쒓렇 ?쒖젏???섎텋 愿???뺤콉 ?뚮씪誘명꽣?앸? Reservation??湲곕줉?대몢??寃껋씠??

- **SSOT(寃곗젙)**: refund_policy / preview 濡쒖쭅
- **Evidence(?ы쁽 洹쇨굅)**: refund_snapshot + shipping_snapshot + time_snapshot + activity_log

利?
- ?섏쨷???뺤콉媛믪씠 諛붾뚮뜑?쇰룄,
- 怨쇨굅 ?덉빟 耳?댁뒪瑜??쒕떦???뺤콉 湲곗??앹쑝濡??ㅻ챸/?ы쁽?????덈떎.

### 7-2) 硫깅벑 洹쒖튃(以묒슂)
- `refund_snapshot`???대? ?덉쑝硫?**?ш린濡앺븯吏 ?딅뒗??*
  - captured_at??怨좎젙?섏뼱???쒕컯?쒋앷? ?쒕떎.

### 7-3) ????꾩튂
- `Reservation.policy_snapshot_json["refund_snapshot"]`

---

## 8) Refund Snapshot ?쒖? ??

`policy_snapshot_json.refund_snapshot.keys`:

- `refund.dispute_hold_days`

異붽? ?ㅺ? ?꾩슂?댁?硫?`CANON_KEYS`???뺤옣?쒕떎.

---

## 9) ActivityLog(洹쇨굅) ?쒖?

?묓릟??CS ?ㅻ챸???꾪빐 ?섎텋 preview/?ㅽ뻾? 濡쒓렇瑜??④린??寃껋쓣 沅뚯옣?쒕떎.

沅뚯옣 ?꾨뱶:
- actor_type: buyer|seller|admin|system|agent
- actor_id
- event_type:
  - `refund.preview.v36`
  - `evidence_pack.refund_dispute_v1`
  - `refund.executed.*` (?ㅼ쭛????
- buyer_id / seller_id / deal_id / offer_id / reservation_id
- meta(JSON): preview 怨꾩궛媛? shipping gate 寃곌낵, override ?뺣낫 ??
- policy_snapshot_ref(?좏깮): meta??policy_version/hash瑜??댁븘????

---

## 10) ?댁쁺/CS/?묓릟???ㅻ챸 ?쒗뵆由?

?꾨옒 ?쒖꽌?濡쒕쭔 留먰븯硫?寃곕줎???붾뱾由ъ? ?딅뒗??

1) **?꾩옱 ?곹깭**
- ?덉빟 ?곹깭(PAID/??
- 諛곗넚 ?곹깭(shipped/delivered/arrival_confirmed)
- 遺꾩웳 ?щ?(dispute open?)

2) **?섎텋 媛???щ?**
- cooling_state(SSOT)
- trigger/fault_party(?낅젰 or actor 留ㅽ븨)
- shipping gate 寃곌낵(諛곗넚鍮??ы븿 ?щ?)

3) **湲덉븸**
- ?곹뭹 ?섎텋???섎웾횞?④?)
- 諛곗넚鍮??섎텋???먮룞諛곗젙/override/cap + gate)
- 珥??섎텋??

4) **洹쇨굅**
- ActivityLog ?대깽??
- Reservation policy_snapshot(refund/shipping/time)
- (?꾩슂 ?? offer_policy.cancel_within_days

5) **?ㅼ쓬 ?④퀎**
- ?먮룞 泥섎━(?덈떎硫??몃━嫄??쒓컙)
- 愿由ъ옄 寃???꾩슂 ?щ?
- ?꾩슂??利앸튃(?ъ쭊/?댁넚?????濡쒓렇)

---

## 11) ?뺣━

- refund_policy/preview 濡쒖쭅??**寃곗젙(SSOT)** ?대떎.
- refund_snapshot? **利앸튃(Evidence)** ?대떎.
- ActivityLog??**異붿쟻/?듦퀎/?뺤콉 ?쒕떇**???꾪븳 ?대깽??湲곕컲 洹쇨굅??

?곕씪???쒖뒪?낆꺑??諛뺤젣?쒕떎?앸뒗 寃껋?
?섎텋 怨꾩궛??諛붽씀??寃껋씠 ?꾨땲??
**?섏쨷???ㅻ챸/?ы쁽 媛?ν븳 洹쇨굅瑜?Reservation???④릿??*???살씠??
